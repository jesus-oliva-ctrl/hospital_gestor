@page "/historial-consultas"
@using HospitalData.DTOs
@using HospitalData.Services
@using HospitalData.Models
@using HospitalWeb.Components.Shared
@inject IDoctorService DoctorService
@inject IAdminDoctorService AdminDoctorService 
@inject UserSessionService SessionService
@inject ISnackbar Snackbar

<PageTitle>Historial de Consultas</PageTitle>

<Autorizacion RolRequerido="Medico">

    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
        
        <MudStack Spacing="3">
            
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.History" Color="Color.Primary" Size="Size.Large" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h4">Mi Historial de Consultas</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Registro completo de citas finalizadas
                    </MudText>
                </MudStack>
            </MudStack>

            <MudDivider />

            @if (_isLoading)
            {
                <MudPaper Elevation="0" Class="d-flex justify-center align-center pa-8">
                    <MudStack AlignItems="AlignItems.Center" Spacing="3">
                        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                        <MudText Typo="Typo.h6" Color="Color.Secondary">Cargando historial...</MudText>
                    </MudStack>
                </MudPaper>
            }
            else if (_historial == null || !_historial.Any())
            {
                <MudPaper Elevation="2" Class="pa-8">
                    <MudStack AlignItems="AlignItems.Center" Spacing="3">
                        <MudIcon Icon="@Icons.Material.Filled.FolderOpen" 
                                Size="Size.Large" 
                                Color="Color.Info" 
                                Style="font-size: 80px;" />
                        <MudText Typo="Typo.h6" Align="Align.Center">
                            No hay registros en tu historial
                        </MudText>
                        <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
                            Las consultas completadas aparecerán aquí
                        </MudText>
                    </MudStack>
                </MudPaper>
            }
            else
            {
                <MudPaper Elevation="2" Class="pa-4">
                    <MudStack Spacing="2" Class="mb-4">
                        <MudStack Row="true" JustifyContent="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.h6">
                                <MudIcon Icon="@Icons.Material.Filled.ListAlt" Class="mr-2" />
                                Consultas Realizadas
                            </MudText>
                            <MudChip T="string" Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success">
                                @_historial.Count consulta@(_historial.Count != 1 ? "s" : "")
                            </MudChip>
                        </MudStack>
                    </MudStack>

                    <MudTable Items="@_historial" 
                              Hover="true" 
                              Breakpoint="Breakpoint.Sm"
                              Dense="false"
                              Striped="true"
                              Elevation="0">
                        <HeaderContent>
                            <MudTh><MudTableSortLabel SortBy="new Func<MedicalHistoryDto, object>(x => x.VisitDate)">
                                Fecha
                            </MudTableSortLabel></MudTh>
                            <MudTh>Paciente</MudTh>
                            <MudTh>Diagnóstico / Notas</MudTh>
                            <MudTh Style="text-align: right">Acciones</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Fecha">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body1">
                                        <strong>@context.VisitDate.ToString("dd/MM/yyyy")</strong>
                                    </MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @context.VisitDate.ToString("HH:mm")
                                    </MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Paciente">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudAvatar Color="Color.Primary" Size="Size.Small">
                                        <MudIcon Icon="@Icons.Material.Filled.Person" />
                                    </MudAvatar>
                                    <MudText Typo="Typo.body1">
                                        @context.PatientFirstName @context.PatientLastName
                                    </MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Diagnóstico">
                                <MudText Typo="Typo.body2" Style="max-width: 400px; white-space: normal;">
                                    @(context.Description?.Length > 100 
                                        ? context.Description.Substring(0, 100) + "..." 
                                        : context.Description)
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Acciones" Style="text-align: right">
                                <MudButton Variant="Variant.Outlined"
                                          Color="Color.Primary"
                                          Size="Size.Small"
                                          StartIcon="@Icons.Material.Filled.EventRepeat"
                                          OnClick="@(() => OpenFollowUpDialog(context))">
                                    Seguimiento
                                </MudButton>
                            </MudTd>
                        </RowTemplate>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new int[]{10, 25, 50}" />
                        </PagerContent>
                    </MudTable>
                </MudPaper>
            }

        </MudStack>

    </MudContainer>

</Autorizacion>

@if (_showFollowUpDialog)
{
    <MudOverlay Visible="true" DarkBackground="true" OnClick="CloseFollowUpDialog" ZIndex="1300" />
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1400; width: 90%; max-width: 500px;">
        <MudPaper Elevation="8" Class="pa-6">
            <MudStack Spacing="3">
                <MudStack Row="true" JustifyContent="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Color="Color.Primary" Class="mr-2" />
                        Agendar Seguimiento
                    </MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                  Color="Color.Default" 
                                  OnClick="CloseFollowUpDialog" />
                </MudStack>

                <MudDivider />

                @if (_selectedHistoryRecord != null)
                {
                    <MudAlert Severity="Severity.Info" Dense="true" Class="my-2">
                        <MudText Typo="Typo.body2">
                            <strong>Paciente:</strong> @_selectedHistoryRecord.PatientFirstName @_selectedHistoryRecord.PatientLastName
                        </MudText>
                        <MudText Typo="Typo.caption">
                            Consulta anterior: @_selectedHistoryRecord.VisitDate.ToString("dd/MM/yyyy")
                        </MudText>
                    </MudAlert>

                    <MudGrid>
                        <MudItem xs="12" sm="6">
                             <MudDatePicker @bind-Date="_newFollowUpDate"
                                 Label="Fecha"
                                 Variant="Variant.Outlined"
                                 MinDate="DateTime.Today"
                                 Required="true"
                                 DateFormat="dd/MM/yyyy" 
                                 Adornment="Adornment.Start" 
                                 AdornmentIcon="@Icons.Material.Filled.Event" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTimePicker @bind-Time="_newFollowUpTime"
                                 Label="Hora"
                                 Variant="Variant.Outlined"
                                 Required="true"
                                 AmPm="true" 
                                 Adornment="Adornment.Start" 
                                 AdornmentIcon="@Icons.Material.Filled.AccessTime" />
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="mt-2" />

                    <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
                        <MudButton Variant="Variant.Text" 
                                  Color="Color.Secondary"
                                  OnClick="CloseFollowUpDialog"
                                  Disabled="_isSubmitting">
                            Cancelar
                        </MudButton>
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   OnClick="HandleScheduleFollowUp"
                                   StartIcon="@Icons.Material.Filled.CheckCircle"
                                   Disabled="_isSubmitting">
                            @if (_isSubmitting)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">Agendando...</MudText>
                            }
                            else
                            {
                                <MudText>Confirmar Cita</MudText>
                            }
                        </MudButton>
                    </MudStack>
                }
            </MudStack>
        </MudPaper>
    </div>
}

@code 
{
    private List<MedicalHistoryDto>? _historial;
    private bool _isLoading = true;
    
    private bool _showFollowUpDialog = false;
    private bool _isSubmitting = false;
    private MedicalHistoryDto? _selectedHistoryRecord;
    
    private DateTime? _newFollowUpDate = DateTime.Now.AddDays(7);
    private TimeSpan? _newFollowUpTime = new TimeSpan(9, 0, 0);

    protected override async Task OnInitializedAsync()
    {
        if (SessionService.CurrentUser?.RoleName == "Medico")
        {
            await LoadHistorial();
        }
    }

    private async Task LoadHistorial()
    {
        try
        {
            _isLoading = true;
            
            if (SessionService.CurrentUser == null)
            {
                Snackbar.Add("Error: Usuario no autenticado", Severity.Error);
                return;
            }
            
            int doctorUserId = SessionService.CurrentUser.UserID; 
            _historial = await DoctorService.GetMyMedicalHistoryAsync(doctorUserId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar el historial: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OpenFollowUpDialog(MedicalHistoryDto record)
    {
        _selectedHistoryRecord = record;
        _newFollowUpDate = DateTime.Now.AddDays(7);
        _newFollowUpTime = new TimeSpan(9, 0, 0);
        _showFollowUpDialog = true;
    }
    
    private void CloseFollowUpDialog()
    {
        _showFollowUpDialog = false;
        _selectedHistoryRecord = null;
        _isSubmitting = false;
    }

    private async Task HandleScheduleFollowUp()
    {
        if (_isSubmitting) return;

        _isSubmitting = true;

        try
        {
            if (_selectedHistoryRecord == null || SessionService.CurrentUser == null)
            {
                Snackbar.Add("Error de validación", Severity.Error);
                return;
            }

            if (!_newFollowUpDate.HasValue || !_newFollowUpTime.HasValue)
            {
                Snackbar.Add("Debe seleccionar fecha y hora para la cita", Severity.Warning);
                return;
            }

            var doctores = await AdminDoctorService.GetAllDoctorsAsync();
            var miDoctor = doctores.FirstOrDefault(d => d.UserID == SessionService.CurrentUser.UserID);

            if (miDoctor == null)
            {
                Snackbar.Add("Error: No se encontró tu perfil de médico.", Severity.Error);
                return;
            }

            var newAppointmentDto = new ScheduleAppointmentDto
            {
                PatientID = _selectedHistoryRecord.PatientID,
                DoctorID = miDoctor.DoctorId,
                AppointmentDate = _newFollowUpDate.Value.Date.Add(_newFollowUpTime.Value)
            };

            await DoctorService.ScheduleNewAppointmentAsync(newAppointmentDto);
            
            Snackbar.Add("Cita de seguimiento agendada exitosamente", Severity.Success);
            CloseFollowUpDialog();
            
            await LoadHistorial();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al agendar: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}