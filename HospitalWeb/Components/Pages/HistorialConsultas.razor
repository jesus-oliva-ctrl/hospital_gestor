@page "/historial-consultas"
@using HospitalData.DTOs
@using HospitalData.Services
@using System.Linq.Expressions
@inject IDoctorService DoctorService
@inject UserSessionService SessionService

<PageTitle>Historial de Consultas</PageTitle>

<Autorizacion RolRequerido="Medico">

    <h1>Mi Historial de Consultas</h1>
    <p>Aquí puede ver un registro de todas sus citas completadas.</p>
    <hr />

    @if (_historial == null)
    {
        <p><em>Cargando historial...</em></p>
    }
    else if (!_historial.Any())
    {
        <p>No tiene registros en su historial médico.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Paciente</th>
                    <th>Notas / Diagnóstico</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var registro in _historial)
                {
                    <tr>
                        <td>@registro.VisitDate.ToString("d")</td>
                        <td>@registro.PatientFirstName @registro.PatientLastName</td>
                        <td>@registro.Description</td>
                        <td>
                            <button class="btn btn-sm btn-secondary"
                                @onclick="() => OpenFollowUpModal(registro)">
                                Agendar Seguimiento
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

</Autorizacion>

@if (_showModal)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agendar Cita de Seguimiento</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(_modalErrorMessage))
                    {
                        <div class="alert alert-danger">@_modalErrorMessage</div>
                    }
                    <div class="mb-3">
                        <label>Nueva Fecha y Hora:</label>
                        <InputDate @bind-Value="_newFollowUpDate" class="form-control" Type="InputDateType.DateTimeLocal" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModal">Cancelar</button>
                    <button class="btn btn-primary" @onclick="HandleScheduleFollowUp">Agendar Cita</button>
                </div>
            </div>
        </div>
    </div>

}

@code 
{
    private List<MedicalHistoryDto>? _historial;
    private bool _showModal = false;
    private MedicalHistoryDto? _selectedHistoryRecord;
    private DateTime _newFollowUpDate = DateTime.Now.AddDays(7);
    private string? _modalErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (SessionService.CurrentUser?.RoleName == "Medico")
        {
            try
            {
                int doctorUserId = SessionService.CurrentUser.UserID;
                _historial = await DoctorService.GetMyMedicalHistoryAsync(doctorUserId);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al cargar el historial: {ex.Message}");
            }
        }
    }

    private void OpenFollowUpModal(MedicalHistoryDto record)
    {
        _selectedHistoryRecord = record;
        _newFollowUpDate = DateTime.Now.AddDays(7);
        _modalErrorMessage = null;
        _showModal = true;
    }
    
    private void CloseModal()
    {
        _showModal = false;
        _selectedHistoryRecord = null;
    }
    private async Task HandleScheduleFollowUp()
    {
        _modalErrorMessage = null;
        if (_selectedHistoryRecord == null || SessionService.CurrentUser == null)
        {
            _modalErrorMessage = "Error: No se ha seleccionado un paciente o usuario.";
            return;
        }

        try
        {
            int doctorId = await DoctorService.GetMyDoctorIdAsync(SessionService.CurrentUser.UserID);

            var newAppointmentDto = new ScheduleAppointmentDto
            {
                PatientID = _selectedHistoryRecord.PatientID,
                DoctorID = doctorId,
                AppointmentDate = _newFollowUpDate
            };

            await DoctorService.ScheduleNewAppointmentAsync(newAppointmentDto);

            CloseModal(); 
        }
        catch (Exception ex)
        {
            _modalErrorMessage = ex.Message;
        }
    }
}