@page "/gestion-laboratoristas"
@using HospitalData.DTOs
@using HospitalData.Services
@using HospitalWeb.Components.Shared
@inject IAdminLabService AdminService
@inject ISnackbar Snackbar

<PageTitle>Gestión de Laboratoristas</PageTitle>

<Autorizacion RolRequerido="Administrativo">

    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
        
        <MudStack Spacing="3">
            
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Biotech" Color="Color.Primary" Size="Size.Large" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h4">Directorio de Laboratorio</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Gestión de técnicos y personal de laboratorio
                    </MudText>
                </MudStack>
            </MudStack>

            <MudDivider />

            <MudTabs Elevation="4" Rounded="true" ApplyEffectsToContainer="true" Color="Color.Primary">
                
                <MudTabPanel Text="Lista de Técnicos" Icon="@Icons.Material.Filled.List">
                    <MudPaper Elevation="0" Class="pa-4">
                        
                        @if (_isLoading)
                        {
                            <MudStack AlignItems="AlignItems.Center" Spacing="3" Class="pa-8">
                                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                                <MudText Typo="Typo.h6" Color="Color.Secondary">Cargando personal de laboratorio...</MudText>
                            </MudStack>
                        }
                        else if (_listaTecnicos == null || !_listaTecnicos.Any())
                        {
                            <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info">
                                No hay laboratoristas registrados en el sistema
                            </MudAlert>
                        }
                        else
                        {
                            <MudTable Items="@_listaTecnicos" 
                                      Dense="false" 
                                      Hover="true" 
                                      Bordered="false" 
                                      Striped="true" 
                                      Filter="new Func<LabTechnicianDto,bool>(FilterFunc1)"
                                      Elevation="0">
                                <ToolBarContent>
                                    <MudStack Row="true" JustifyContent="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="flex-grow-1">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudIcon Icon="@Icons.Material.Filled.Badge" Color="Color.Primary" />
                                            <MudText Typo="Typo.h6">Técnicos Registrados</MudText>
                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">
                                                @_listaTecnicos.Count
                                            </MudChip>
                                        </MudStack>
                                        <MudTextField @bind-Value="_searchString" 
                                                      Placeholder="Buscar por nombre o área..." 
                                                      Adornment="Adornment.Start" 
                                                      AdornmentIcon="@Icons.Material.Filled.Search" 
                                                      IconSize="Size.Medium"
                                                      Variant="Variant.Outlined"
                                                      Margin="Margin.Dense"
                                                      Clearable="true" />
                                    </MudStack>
                                </ToolBarContent>
                                <HeaderContent>
                                    <MudTh>ID</MudTh>
                                    <MudTh><MudTableSortLabel SortBy="new Func<LabTechnicianDto, object>(x=>x.FirstName)">Nombre</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="new Func<LabTechnicianDto, object>(x=>x.LastName)">Apellido</MudTableSortLabel></MudTh>
                                    <MudTh>Teléfono</MudTh>
                                    <MudTh><MudTableSortLabel SortBy="new Func<LabTechnicianDto, object>(x=>x.AreaName)">Área Asignada</MudTableSortLabel></MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="ID">
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@context.LabTechID</MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Nombre">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudAvatar Color="Color.Primary" Size="Size.Small">
                                                <MudIcon Icon="@Icons.Material.Filled.Science" Size="Size.Small" />
                                            </MudAvatar>
                                            <MudText Typo="Typo.body1">@context.FirstName</MudText>
                                        </MudStack>
                                    </MudTd>
                                    <MudTd DataLabel="Apellido">
                                        <MudText Typo="Typo.body1"><strong>@context.LastName</strong></MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Teléfono">
                                        @if (!string.IsNullOrEmpty(context.Phone))
                                        {
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Color="Color.Info" />
                                                <MudText Typo="Typo.body2">@context.Phone</MudText>
                                            </MudStack>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">-</MudText>
                                        }
                                    </MudTd>
                                    <MudTd DataLabel="Área">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.Workspaces">
                                            @context.AreaName
                                        </MudChip>
                                    </MudTd>
                                </RowTemplate>
                                <PagerContent>
                                    <MudTablePager PageSizeOptions="new int[]{10, 25, 50, 100}" />
                                </PagerContent>
                            </MudTable>
                        }
                    </MudPaper>
                </MudTabPanel>

                <MudTabPanel Text="Registrar Nuevo" Icon="@Icons.Material.Filled.PersonAdd">
                    <MudPaper Elevation="0" Class="pa-4">
                        <MudCard Elevation="2">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.PersonAddAlt1" Color="Color.Primary" Size="Size.Medium" />
                                        <MudText Typo="Typo.h6">Nuevo Laboratorista</MudText>
                                    </MudStack>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <EditForm Model="_nuevoTecnico" OnValidSubmit="HandleCrearTecnico">
                                    <DataAnnotationsValidator />
                                    
                                    <MudGrid>
                                        <MudItem xs="12" sm="6">
                                            <MudTextField @bind-Value="_nuevoTecnico.FirstName" 
                                                          Label="Nombres" 
                                                          Variant="Variant.Outlined"
                                                          Required="true"
                                                          Adornment="Adornment.Start"
                                                          AdornmentIcon="@Icons.Material.Filled.Person" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6">
                                            <MudTextField @bind-Value="_nuevoTecnico.LastName" 
                                                          Label="Apellidos" 
                                                          Variant="Variant.Outlined"
                                                          Required="true"
                                                          Adornment="Adornment.Start"
                                                          AdornmentIcon="@Icons.Material.Filled.Person" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6">
                                            <MudTextField @bind-Value="_nuevoTecnico.Email" 
                                                          Label="Email" 
                                                          Variant="Variant.Outlined"
                                                          InputType="InputType.Email" 
                                                          Required="true"
                                                          Adornment="Adornment.Start"
                                                          AdornmentIcon="@Icons.Material.Filled.Email" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6">
                                            <MudTextField @bind-Value="_nuevoTecnico.Phone" 
                                                          Label="Teléfono" 
                                                          Variant="Variant.Outlined"
                                                          Adornment="Adornment.Start"
                                                          AdornmentIcon="@Icons.Material.Filled.Phone" />
                                        </MudItem>
                                        
                                        <MudItem xs="12">
                                            <MudSelect T="int" 
                                                       Label="Área de Laboratorio" 
                                                       @bind-Value="_nuevoTecnico.AreaID"
                                                       Variant="Variant.Outlined"
                                                       AnchorOrigin="Origin.BottomCenter"
                                                       Adornment="Adornment.Start"
                                                       AdornmentIcon="@Icons.Material.Filled.Category"
                                                       Required="true">
                                                <MudSelectItem Value="0">-- Seleccione un Área --</MudSelectItem>
                                                @foreach (var area in _listaAreas)
                                                {
                                                    <MudSelectItem Value="@area.AreaID">@area.AreaName</MudSelectItem>
                                                }
                                            </MudSelect>
                                        </MudItem>
                                    </MudGrid>

                                    <MudDivider Class="my-4" />

                                    <MudButton Variant="Variant.Filled" 
                                               Color="Color.Primary" 
                                               Size="Size.Large"
                                               FullWidth="true"
                                               StartIcon="@Icons.Material.Filled.Save"
                                               ButtonType="ButtonType.Submit">
                                        Registrar Laboratorista
                                    </MudButton>
                                </EditForm>
                            </MudCardContent>
                        </MudCard>

                        <MudAlert Severity="Severity.Info" Class="mt-4" Dense="true" Icon="@Icons.Material.Filled.Info">
                            Se creará automáticamente un usuario con contraseña por defecto para el nuevo técnico.
                        </MudAlert>
                    </MudPaper>
                </MudTabPanel>
            </MudTabs>

        </MudStack>

    </MudContainer>

</Autorizacion>

@code {
    private List<LabTechnicianDto>? _listaTecnicos;
    private List<LabAreaDto> _listaAreas = new();
    
    private CreateTechModel _nuevoTecnico = new();
    
    private string _searchString = "";
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task HandleCrearTecnico()
    {
        if (_nuevoTecnico.AreaID == 0)
        {
            Snackbar.Add("Debe seleccionar un área de laboratorio", Severity.Warning);
            return;
        }

        try
        {
            await AdminService.CreateTechnicianAsync(
                _nuevoTecnico.FirstName, 
                _nuevoTecnico.LastName, 
                _nuevoTecnico.Email, 
                _nuevoTecnico.Phone, 
                _nuevoTecnico.AreaID
            );

            Snackbar.Add("Laboratorista creado exitosamente", Severity.Success);
            _nuevoTecnico = new(); 
            await CargarDatos(); 
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task CargarDatos()
    {
        try
        {
            _isLoading = true;

            _listaTecnicos = await AdminService.GetAllTechniciansAsync();

            _listaAreas = await AdminService.GetAllAreasAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar datos: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }


    private bool FilterFunc1(LabTechnicianDto element) => FilterFunc(element, _searchString);

    private bool FilterFunc(LabTechnicianDto element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString)) 
            return true;
        if (element.FirstName.Contains(searchString, StringComparison.OrdinalIgnoreCase)) 
            return true;
        if (element.LastName.Contains(searchString, StringComparison.OrdinalIgnoreCase)) 
            return true;
        if ($"{element.FirstName} {element.LastName}".Contains(searchString, StringComparison.OrdinalIgnoreCase)) 
            return true;
        if (element.AreaName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    public class CreateTechModel
    {
        public string FirstName { get; set; } = "";
        public string LastName { get; set; } = "";
        public string Email { get; set; } = "";
        public string Phone { get; set; } = "";
        public int AreaID { get; set; }
    }
}