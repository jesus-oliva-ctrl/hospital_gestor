@page "/agendar-cita"
@using HospitalData.Models
@using HospitalData.Services
@using HospitalData.DTOs
@using HospitalWeb.Components.Shared
@inject IPatientService PatientService
@inject UserSessionService SessionService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Agendar Cita</PageTitle>

<Autorizacion RolRequerido="Paciente">
    
    <MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
        <MudPaper Elevation="3" Class="pa-6">
            <MudStack Spacing="4">
                
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Color="Color.Success" Size="Size.Large" />
                    <MudText Typo="Typo.h4" Color="Color.Success">Nueva Cita Médica</MudText>
                </MudStack>

                <MudDivider />

                <EditForm Model="_newAppointment" OnValidSubmit="HandleScheduleAppointment">
                    <DataAnnotationsValidator />
                    
                    <MudStack Spacing="4">
                        
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle1" Class="fw-bold">
                                <MudIcon Icon="@Icons.Material.Filled.MedicalServices" Size="Size.Small" Class="mr-1" />
                                Seleccione su médico especialista
                            </MudText>
                            
                            @if (_doctorsList == null)
                            {
                                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Cargando médicos disponibles...</MudText>
                            }
                            else
                            {
                                <MudSelect T="int" 
                                           @bind-Value="_newAppointment.DoctorID" 
                                           Label="Médico" 
                                           Variant="Variant.Outlined"
                                           AnchorOrigin="Origin.BottomCenter"
                                           Required="true"
                                           RequiredError="Debe seleccionar un médico">
                                    <MudSelectItem T="int" Value="0">-- Seleccione un médico --</MudSelectItem>
                                    @foreach (var doc in _doctorsList)
                                    {
                                        <MudSelectItem T="int" Value="@doc.DoctorId">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudAvatar Color="Color.Primary" Size="Size.Small">
                                                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                                                </MudAvatar>
                                                <MudStack Spacing="0">
                                                    <MudText Typo="Typo.body1">Dr. @doc.LastName @doc.FirstName</MudText>
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@(doc.Specialty?.SpecialtyName ?? "General")</MudText>
                                                </MudStack>
                                            </MudStack>
                                        </MudSelectItem>
                                    }
                                </MudSelect>
                            }
                        </MudStack>

                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle1" Class="fw-bold">
                                <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Class="mr-1" />
                                Fecha y hora deseada
                            </MudText>
                            
                            <MudDatePicker Label="Fecha" 
                                          @bind-Date="_selectedDate"
                                          Variant="Variant.Outlined"
                                          MinDate="DateTime.Today"
                                          Required="true"
                                          Editable="true"
                                          DateFormat="dd/MM/yyyy"
                                          FirstDayOfWeek="DayOfWeek.Monday" />
                            
                            <MudTimePicker Label="Hora" 
                                          @bind-Time="_selectedTime"
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          Editable="true"
                                          AmPm="true" />
                            
                            <MudAlert Severity="Severity.Info" Dense="true" Icon="@Icons.Material.Filled.Info">
                                Los horarios están sujetos a disponibilidad del médico
                            </MudAlert>
                        </MudStack>

                        <MudStack Row="true" Spacing="2" Class="mt-4">
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Success" 
                                      Size="Size.Large"
                                      FullWidth="true"
                                      StartIcon="@Icons.Material.Filled.CheckCircle"
                                      ButtonType="ButtonType.Submit">
                                Confirmar Cita
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" 
                                      Color="Color.Default" 
                                      Size="Size.Large"
                                      Href="mis-citas"
                                      StartIcon="@Icons.Material.Filled.Cancel">
                                Cancelar
                            </MudButton>
                        </MudStack>

                    </MudStack>
                </EditForm>

            </MudStack>
        </MudPaper>
    </MudContainer>

</Autorizacion>

@code {
    private ScheduleAppointmentDto _newAppointment = new();
    private List<Doctor>? _doctorsList;
    private int _patientId;
    private DateTime? _selectedDate = DateTime.Today.AddDays(1);
    private TimeSpan? _selectedTime = new TimeSpan(9, 0, 0);

    protected override async Task OnInitializedAsync()
    {
        if (SessionService.CurrentUser?.RoleName == "Paciente")
        {
            try
            {
                _patientId = await PatientService.GetPatientIdByUserIdAsync(SessionService.CurrentUser.UserID);
                
                _doctorsList = await PatientService.GetActiveDoctorsAsync();
                
                _newAppointment.PatientID = _patientId;
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error al cargar datos: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task HandleScheduleAppointment()
    {
        if (_newAppointment.DoctorID <= 0)
        {
            Snackbar.Add("Por favor, seleccione un médico de la lista", Severity.Warning);
            return;
        }

        if (_selectedDate.HasValue && _selectedTime.HasValue)
        {
            _newAppointment.AppointmentDate = _selectedDate.Value.Date.Add(_selectedTime.Value);
        }

        try
        {
            await PatientService.ScheduleAppointmentAsync(_newAppointment);
            
            Snackbar.Add("¡Cita agendada exitosamente!", Severity.Success);
            
            await Task.Delay(1500);
            NavigationManager.NavigateTo("/mis-citas");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
}