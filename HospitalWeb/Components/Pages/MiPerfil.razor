@page "/mi-perfil"
@using HospitalData.DTOs
@using HospitalData.Services
@inject IUserAccountService AccountService
@inject UserSessionService SessionService
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<PageTitle>Mi Perfil</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    
    <MudText Typo="Typo.h4" Class="mb-4">游녻 Mi Perfil</MudText>

    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudCard Elevation="3">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Editar Informaci칩n Personal</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Rol: <strong>@_profile.Role</strong>
                    </MudText>
                </CardHeaderContent>
            </MudCardHeader>
            
            <MudCardContent>
                <EditForm Model="_profile" OnValidSubmit="HandleUpdate">
                    <DataAnnotationsValidator />

                    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
                        
                        <MudTabPanel Text="Datos B치sicos" Icon="@Icons.Material.Filled.Person">
                            <MudGrid>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_profile.FirstName" Label="Nombre" Variant="Variant.Outlined" Required="true" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_profile.LastName" Label="Apellido" Variant="Variant.Outlined" Required="true" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_profile.Email" Label="Email" Variant="Variant.Outlined" InputType="InputType.Email" Required="true" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_profile.Phone" Label="Tel칠fono" Variant="Variant.Outlined" />
                                </MudItem>
                                
                                @if (_profile.Role == "Paciente")
                                {
                                    <MudItem xs="12">
                                        <MudTextField @bind-Value="_profile.Address" Label="Direcci칩n Domiciliaria" Variant="Variant.Outlined" Lines="2" />
                                    </MudItem>
                                }
                            </MudGrid>
                        </MudTabPanel>

                        <MudTabPanel Text="Seguridad y Acceso" Icon="@Icons.Material.Filled.Security">
                            <MudAlert Severity="Severity.Info" Class="mb-4" Dense="true">
                                Deje los campos de contrase침a en blanco si no desea cambiarla.
                            </MudAlert>

                            <MudGrid>
                                <MudItem xs="12">
                                    <MudTextField @bind-Value="_profile.Username" Label="Nombre de Usuario" Variant="Variant.Outlined" Required="true" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_profile.NewPassword" 
                                                  Label="Nueva Contrase침a" 
                                                  Variant="Variant.Outlined" 
                                                  InputType="InputType.Password" />
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    <MudTextField @bind-Value="_profile.ConfirmPassword" 
                                                  Label="Confirmar Contrase침a" 
                                                  Variant="Variant.Outlined" 
                                                  InputType="InputType.Password"
                                                  For="@(() => _profile.ConfirmPassword)" />
                                </MudItem>
                            </MudGrid>
                        </MudTabPanel>
                    
                    </MudTabs>

                    <MudDivider Class="my-4" />

                    <MudButton ButtonType="ButtonType.Submit" 
                               Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               Size="Size.Large"
                               FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Save">
                        Guardar Cambios
                    </MudButton>

                </EditForm>
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    private UserProfileDto _profile = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        var currentUser = SessionService.CurrentUser;
        if (currentUser != null)
        {
            try 
            {
                _profile = await AccountService.GetUserProfileAsync(currentUser.UserID);
            }
            catch (Exception ex)
            {
                Snackbar.Add("Error al cargar perfil: " + ex.Message, Severity.Error);
            }
            finally
            {
                _isLoading = false;
            }
        }
        else
        {
            Nav.NavigateTo("/login");
        }
    }

    private async Task HandleUpdate()
    {
        try
        {
            await AccountService.UpdateUserProfileAsync(_profile);
            
            Snackbar.Add("Perfil actualizado correctamente.", Severity.Success);
            
            if (!string.IsNullOrEmpty(_profile.NewPassword))
            {
                Snackbar.Add("Contrase침a cambiada. Por favor inicie sesi칩n nuevamente.", Severity.Warning);
                await Task.Delay(2000);
                Nav.NavigateTo("/logout"); 
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al guardar: {ex.Message}", Severity.Error);
        }
    }
}