@page "/cita/{AppointmentId:int}"
@using HospitalData.Models
@using HospitalData.Services
@using HospitalData.DTOs
@using HospitalWeb.Components.Shared 
@inject IDoctorService DoctorService
@inject ILabResultService LabService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Detalle de la Cita</PageTitle>

<Autorizacion RolRequerido="Medico">

    @if (_isLoading)
    {
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
            <MudPaper Elevation="0" Class="d-flex justify-center align-center pa-8">
                <MudStack AlignItems="AlignItems.Center" Spacing="3">
                    <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                    <MudText Typo="Typo.h6" Color="Color.Secondary">Cargando información del paciente...</MudText>
                </MudStack>
            </MudPaper>
        </MudContainer>
    }
    else if (_appointment == null)
    {
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
            <MudAlert Severity="Severity.Error" Icon="@Icons.Material.Filled.Error">
                No se pudo cargar la información de la cita.
            </MudAlert>
        </MudContainer>
    }
    else
    {
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
            
            <MudStack Spacing="4">
                
                <MudPaper Elevation="3" Class="pa-4">
                    <MudStack Row="true" JustifyContent="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.PersonPin" Color="Color.Primary" Size="Size.Large" />
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.h4">
                                    @_appointment.Patient.FirstName @_appointment.Patient.LastName
                                </MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    Cita: @_appointment.AppointmentDate.ToString("dd/MM/yyyy HH:mm")
                                </MudText>
                            </MudStack>
                        </MudStack>
                        <MudStack AlignItems="AlignItems.End" Spacing="1">
                            <MudChip T="string" Icon="@Icons.Material.Filled.Info" Color="@GetStatusColor(_appointment.Status)">
                                @_appointment.Status
                            </MudChip>
                            @if (!string.IsNullOrEmpty(_appointment.Patient.Phone))
                            {
                                <MudChip T="string" Icon="@Icons.Material.Filled.Phone" Color="Color.Info" Size="Size.Small">
                                    @_appointment.Patient.Phone
                                </MudChip>
                            }
                        </MudStack>
                    </MudStack>
                </MudPaper>

                <MudGrid>
                    <MudItem xs="12" lg="6">
                        <HistorialClinico PatientId="@_appointment.PatientId" />
                    </MudItem>

                    <MudItem xs="12" lg="6">
                        <MudCard Elevation="3">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Medication" Color="Color.Info" Size="Size.Medium" />
                                        <MudText Typo="Typo.h6">Prescripciones Vigentes</MudText>
                                    </MudStack>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                @if (_addedPrescriptions == null || !_addedPrescriptions.Any())
                                {
                                    <MudAlert Severity="Severity.Info" Dense="true">
                                        El paciente no tiene prescripciones registradas.
                                    </MudAlert>
                                }
                                else
                                {
                                    <MudList T="string" Dense="true">
                                        @foreach (var p in _addedPrescriptions.Take(5))
                                        {
                                            <MudListItem T="string" Icon="@Icons.Material.Filled.Medication">
                                                <MudStack Spacing="0">
                                                    <MudText Typo="Typo.body1"><strong>@p.Medication?.Name</strong></MudText>
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @p.Dosage · @p.QuantityToDispense unidades
                                                    </MudText>
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        Hasta: @p.EndDate?.ToString("dd/MM/yyyy")
                                                    </MudText>
                                                </MudStack>
                                            </MudListItem>
                                            <MudDivider />
                                        }
                                    </MudList>
                                }
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>

                <MudCard Elevation="3">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Science" Color="Color.Secondary" Size="Size.Medium" />
                                <MudText Typo="Typo.h6">Resultados de Laboratorio (Historial)</MudText>
                            </MudStack>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (_labResults == null || !_labResults.Any())
                        {
                            <MudAlert Severity="Severity.Info" Dense="true">
                                No se encontraron resultados de laboratorio previos.
                            </MudAlert>
                        }
                        else
                        {
                            <MudTable Items="@_labResults" Hover="true" Dense="true" Elevation="0">
                                <HeaderContent>
                                    <MudTh>Fecha</MudTh>
                                    <MudTh>Examen</MudTh>
                                    <MudTh>Estado</MudTh>
                                    <MudTh>Acción</MudTh>
                                </HeaderContent>
                                <RowTemplate Context="result">
                                    <MudTd>@result.Date.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</MudTd>
                                    <MudTd><strong>@result.TestName</strong></MudTd>
                                    <MudTd>
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Text">Finalizado</MudChip>
                                    </MudTd>
                                    <MudTd>
                                        <MudButton Variant="Variant.Outlined" 
                                                   Color="Color.Primary" 
                                                   Size="Size.Small"
                                                   OnClick="@(() => ShowLabDetails(result))">
                                            Ver Detalles
                                        </MudButton>
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    </MudCardContent>
                </MudCard>

                <MudPaper Elevation="3" Class="pa-4">
                    <MudStack Spacing="3">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Biotech" Color="Color.Tertiary" Size="Size.Medium" />
                            <MudText Typo="Typo.h6">Solicitar Exámenes de Laboratorio</MudText>
                        </MudStack>

                        <MudGrid AlignItems="AlignItems.End">
                            <MudItem xs="12" md="8">
                                <MudSelect T="int" @bind-Value="_selectedTestId" 
                                           Label="Seleccione el estudio a realizar" 
                                           Variant="Variant.Outlined" 
                                           AnchorOrigin="Origin.BottomCenter"
                                           Dense="true">
                                    <MudSelectItem Value="0">-- Seleccionar --</MudSelectItem>
                                    @if (_availableTests != null)
                                    {
                                        @foreach (var group in _availableTests.GroupBy(t => t.AreaName))
                                        {
                                            <MudListSubheader>@group.Key</MudListSubheader>
                                            @foreach (var test in group)
                                            {
                                                <MudSelectItem Value="@test.TestId">
                                                    @test.TestName - $@test.Price
                                                </MudSelectItem>
                                            }
                                        }
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Tertiary" 
                                           StartIcon="@Icons.Material.Filled.Send"
                                           OnClick="HandleSolicitarLaboratorio"
                                           Disabled="@(_isSendingLabRequest || _selectedTestId == 0)"
                                           FullWidth="true">
                                    @(_isSendingLabRequest ? "Enviando..." : "Enviar Solicitud")
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                        
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            * Al enviar la solicitud, la cita cambiará a estado "En Laboratorio" automáticamente.
                        </MudText>
                    </MudStack>
                </MudPaper>

                <MudPaper Elevation="3" Class="pa-4">
                    <MudStack Spacing="3">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.AddCircle" Color="Color.Success" Size="Size.Medium" />
                            <MudText Typo="Typo.h6">Nueva Prescripción Médica</MudText>
                        </MudStack>

                        <EditForm Model="_newPrescription" OnValidSubmit="HandleAddPrescription">
                            <DataAnnotationsValidator />
                            
                            <MudGrid>
                                <MudItem xs="12" md="6">
                                    <MudSelect T="int" 
                                              @bind-Value="_newPrescription.MedicationID"
                                              Label="Medicamento"
                                              Variant="Variant.Outlined"
                                              Required="true"
                                              AnchorOrigin="Origin.BottomCenter">
                                        <MudSelectItem T="int" Value="0">-- Seleccione medicamento --</MudSelectItem>
                                        @if (_availableMedications != null)
                                        {
                                            @foreach (var med in _availableMedications)
                                            {
                                                <MudSelectItem T="int" Value="@med.MedicationId">
                                                    @med.Name (Stock: @med.Quantity)
                                                </MudSelectItem>
                                            }
                                        }
                                    </MudSelect>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="_newPrescription.Dosage"
                                                Label="Dosis"
                                                Variant="Variant.Outlined"
                                                Placeholder="Ej: 1 pastilla cada 8 horas"
                                                Required="true"
                                                For="@(() => _newPrescription.Dosage)" />
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudNumericField @bind-Value="_newPrescription.QuantityToDispense"
                                                   Label="Cantidad a Despachar"
                                                   Variant="Variant.Outlined"
                                                   Min="1"
                                                   Required="true"
                                                   For="@(() => _newPrescription.QuantityToDispense)" />
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudDatePicker @bind-Date="_prescriptionEndDate"
                                                 Label="Fecha de Fin"
                                                 Variant="Variant.Outlined"
                                                 MinDate="DateTime.Today"
                                                 Required="true"
                                                 DateFormat="dd/MM/yyyy" />
                                </MudItem>

                                <MudItem xs="12">
                                    <MudButton Variant="Variant.Filled"
                                              Color="Color.Success"
                                              StartIcon="@Icons.Material.Filled.Add"
                                              ButtonType="ButtonType.Submit"
                                              FullWidth="true">
                                        Añadir Prescripción
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        </EditForm>
                    </MudStack>
                </MudPaper>

                <MudPaper Elevation="3" Class="pa-4">
                    <MudStack Spacing="3">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Color="Color.Warning" Size="Size.Medium" />
                            <MudText Typo="Typo.h6">Reagendar Cita</MudText>
                        </MudStack>

                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudDatePicker @bind-Date="_newScheduleDate"
                                             Label="Nueva Fecha"
                                             Variant="Variant.Outlined"
                                             MinDate="DateTime.Today"
                                             DateFormat="dd/MM/yyyy" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudTimePicker @bind-Time="_newScheduleTime"
                                             Label="Nueva Hora"
                                             Variant="Variant.Outlined"
                                             AmPm="true" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudButton Variant="Variant.Filled"
                                          Color="Color.Warning"
                                          StartIcon="@Icons.Material.Filled.Update"
                                          OnClick="HandleReagendar"
                                          FullWidth="true">
                                    Reagendar esta Cita
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                    </MudStack>
                </MudPaper>

                <MudPaper Elevation="3" Class="pa-4">
                    <MudStack Spacing="3">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Assignment" Color="Color.Primary" Size="Size.Medium" />
                            <MudText Typo="Typo.h6">Diagnóstico y Finalización</MudText>
                        </MudStack>

                        <MudTextField @bind-Value="_diagnosisNotes"
                                    Label="Notas del Diagnóstico"
                                    Variant="Variant.Outlined"
                                    Lines="5"
                                    Placeholder="Ingrese el diagnóstico y observaciones de la consulta..."
                                    Required="true" />

                        <MudStack Row="true" Spacing="2">
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Success"
                                      StartIcon="@Icons.Material.Filled.CheckCircle"
                                      OnClick="HandleFinalizarCita"
                                      FullWidth="true"
                                      Size="Size.Large">
                                Finalizar Cita
                            </MudButton>
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Error"
                                      StartIcon="@Icons.Material.Filled.Cancel"
                                      OnClick="HandleCancelarCita"
                                      FullWidth="true"
                                      Size="Size.Large">
                                Cancelar Cita
                            </MudButton>
                        </MudStack>
                    </MudStack>
                </MudPaper>

            </MudStack>

        </MudContainer>
    }
</Autorizacion>

@code {
    [Parameter]
    public int AppointmentId { get; set; }

    private Appointment? _appointment;
    private bool _isLoading = true;
    
    private List<InventoryDto>? _availableMedications;
    private List<Prescription>? _addedPrescriptions;
    private List<LabResult>? _labResults;          
    private List<LabTestDto>? _availableTests;     

    private CreatePrescriptionDto _newPrescription = new();
    private DateTime? _prescriptionEndDate = DateTime.Now.AddDays(7);
    private string _diagnosisNotes = "";
    
    private DateTime? _newScheduleDate;
    private TimeSpan? _newScheduleTime = new TimeSpan(9, 0, 0);

    private int _selectedTestId;
    private bool _isSendingLabRequest = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        if (_appointment != null)
        {
            _newScheduleDate = _appointment.AppointmentDate.Date;
            _newScheduleTime = _appointment.AppointmentDate.TimeOfDay;
        }
    }

    private async Task LoadData()
    {
        try
        {
            _isLoading = true;
            _appointment = await DoctorService.GetAppointmentDetailsAsync(AppointmentId);
            
            _availableMedications = await DoctorService.GetAvailableMedicationsAsync();
            _availableTests = await DoctorService.GetAvailableLabTestsAsync(); // Catálogo de Exámenes

            if (_appointment != null)
            {
                _addedPrescriptions = await DoctorService.GetPrescriptionsForPatientAsync(_appointment.PatientId);

                _newPrescription.PatientID = _appointment.PatientId;
                _newPrescription.DoctorID = _appointment.DoctorId;

                _labResults = await LabService.GetHistoryByPatientIdAsync(_appointment.PatientId);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar datos: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }


    private void ShowLabDetails(LabResult result)
    {
        var parameters = new DialogParameters();
        parameters.Add("Result", result);

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        DialogService.Show<LabResultDialog>("Detalle de Resultados", parameters, options);
    }

    private async Task HandleSolicitarLaboratorio()
    {
        if (_selectedTestId == 0)
        {
            Snackbar.Add("Debe seleccionar un examen.", Severity.Warning);
            return;
        }

        try
        {
            _isSendingLabRequest = true;
            await DoctorService.CreateLabRequestAsync(AppointmentId, _selectedTestId);
            
            Snackbar.Add("Solicitud enviada correctamente al laboratorio.", Severity.Success);
            
            await LoadData(); 
            _selectedTestId = 0; 
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        finally
        {
            _isSendingLabRequest = false;
        }
    }


    private async Task HandleAddPrescription()
    {
        if (_appointment == null) return;

        if (_prescriptionEndDate.HasValue)
        {
            _newPrescription.EndDate = _prescriptionEndDate.Value;
        }

        try
        {
            await DoctorService.CreatePrescriptionAsync(_newPrescription);
            Snackbar.Add("Prescripción añadida exitosamente", Severity.Success);
            
            _newPrescription = new()
            {
                PatientID = _appointment.PatientId,
                DoctorID = _appointment.DoctorId
            };
            _prescriptionEndDate = DateTime.Now.AddDays(7);
            
            await LoadData(); 
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleReagendar()
    {
        if (_appointment == null) return;

        if (!_newScheduleDate.HasValue || !_newScheduleTime.HasValue)
        {
            Snackbar.Add("Debe seleccionar fecha y hora", Severity.Warning);
            return;
        }

        var newAppointmentDto = new ScheduleAppointmentDto
        {
            PatientID = _appointment.PatientId,
            DoctorID = _appointment.DoctorId,
            AppointmentDate = _newScheduleDate.Value.Date.Add(_newScheduleTime.Value)
        };

        try
        {
            await DoctorService.RescheduleAppointmentAsync(_appointment.AppointmentId, newAppointmentDto);
            Snackbar.Add("Cita reagendada exitosamente", Severity.Success);
            await Task.Delay(1500);
            NavigationManager.NavigateTo("/panel-doctor");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al reagendar: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleFinalizarCita()
    {
        if (string.IsNullOrWhiteSpace(_diagnosisNotes))
        {
            Snackbar.Add("Debe ingresar las notas del diagnóstico", Severity.Warning);
            return;
        }

        if (_appointment != null)
        {
            try
            {
                await DoctorService.CompleteAppointmentAsync(_appointment.AppointmentId, _diagnosisNotes);
                Snackbar.Add("Cita finalizada exitosamente", Severity.Success);
                await Task.Delay(1500);
                NavigationManager.NavigateTo("/panel-doctor");
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task HandleCancelarCita()
    {
        if (_appointment != null)
        {
            try
            {
                await DoctorService.CancelAppointmentAsync(_appointment.AppointmentId);
                Snackbar.Add("Cita cancelada", Severity.Info);
                await Task.Delay(1500);
                NavigationManager.NavigateTo("/panel-doctor");
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private Color GetStatusColor(string? status) => status switch
    {
        "Programada" => Color.Primary,
        "En Laboratorio" => Color.Warning, 
        "Completada" => Color.Success,
        "Cancelada" => Color.Error,
        _ => Color.Default
    };
}