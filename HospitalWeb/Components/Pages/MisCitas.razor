@page "/mis-citas"
@using HospitalData.Models
@using HospitalData.Services
@using HospitalWeb.Components.Shared
@inject IPatientService PatientService
@inject UserSessionService SessionService
@inject ISnackbar Snackbar

<PageTitle>Mis Citas</PageTitle>

<Autorizacion RolRequerido="Paciente">
    
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
        
        <MudStack Spacing="3">
            
            <MudStack Row="true" JustifyContent="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Color="Color.Primary" Size="Size.Large" />
                    <MudText Typo="Typo.h4">Mis Citas Médicas</MudText>
                </MudStack>
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Success" 
                          StartIcon="@Icons.Material.Filled.Add"
                          Href="agendar-cita"
                          Size="Size.Large">
                    Nueva Cita
                </MudButton>
            </MudStack>

            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Consulta el historial y estado de tus citas médicas programadas
            </MudText>

            <MudDivider />

            @if (_isLoading)
            {
                <MudPaper Elevation="0" Class="d-flex justify-center align-center pa-8">
                    <MudStack AlignItems="AlignItems.Center" Spacing="3">
                        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                        <MudText Typo="Typo.h6" Color="Color.Secondary">Cargando tus citas...</MudText>
                    </MudStack>
                </MudPaper>
            }
            else if (_myAppointments == null || !_myAppointments.Any())
            {
                <MudPaper Elevation="2" Class="pa-8">
                    <MudStack AlignItems="AlignItems.Center" Spacing="3">
                        <MudIcon Icon="@Icons.Material.Filled.EventBusy" Size="Size.Large" Color="Color.Info" Style="font-size: 80px;" />
                        <MudText Typo="Typo.h6" Align="Align.Center">No tienes citas programadas</MudText>
                        <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
                            ¡Es un buen momento para agendar una consulta con uno de nuestros especialistas!
                        </MudText>
                        <MudButton Variant="Variant.Filled" 
                                  Color="Color.Success" 
                                  StartIcon="@Icons.Material.Filled.Add"
                                  Href="agendar-cita"
                                  Size="Size.Large">
                            Agendar Primera Cita
                        </MudButton>
                    </MudStack>
                </MudPaper>
            }
            else
            {
                <MudPaper Elevation="2">
                    <MudTable Items="@_myAppointments" 
                              Hover="true" 
                              Breakpoint="Breakpoint.Sm"
                              Dense="false"
                              Elevation="0">
                        <HeaderContent>
                            <MudTh><MudTableSortLabel SortBy="new Func<VwPatientAppointment, object>(x => x.AppointmentDate)">
                                Fecha y Hora
                            </MudTableSortLabel></MudTh>
                            <MudTh>Doctor</MudTh>
                            <MudTh>Especialidad</MudTh>
                            <MudTh>Estado</MudTh>
                            <MudTh Style="text-align: right">Acciones</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Fecha y Hora">
                                <MudStack Spacing="1">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Color="Color.Primary" />
                                        <MudText Typo="Typo.body2">@context.AppointmentDate.ToString("dd/MM/yyyy")</MudText>
                                    </MudStack>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Color="Color.Secondary" />
                                        <MudText Typo="Typo.body2">@context.AppointmentDate.ToString("hh:mm tt")</MudText>
                                    </MudStack>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Doctor">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudAvatar Color="Color.Primary" Size="Size.Small">
                                        <MudIcon Icon="@Icons.Material.Filled.MedicalServices" />
                                    </MudAvatar>
                                    <MudText Typo="Typo.body1">Dr. @context.DoctorFirstName @context.DoctorLastName</MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Especialidad">
                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.LocalHospital">
                                    @context.DoctorSpecialty
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Estado">
                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                                    @context.Status
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Acciones" Style="text-align: right">
                                @if (context.Status == "Programada")
                                {
                                    <MudButton Variant="Variant.Outlined" 
                                              Color="Color.Error" 
                                              Size="Size.Small"
                                              StartIcon="@Icons.Material.Filled.Cancel"
                                              OnClick="@(() => OpenCancelDialog(context.AppointmentId))">
                                        Cancelar
                                    </MudButton>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">-</MudText>
                                }
                            </MudTd>
                        </RowTemplate>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new int[]{5, 10, 25}" />
                        </PagerContent>
                    </MudTable>
                </MudPaper>
            }

        </MudStack>

    </MudContainer>

</Autorizacion>

@if (_showCancelDialog)
{
    <MudOverlay Visible="true" DarkBackground="true" OnClick="CloseCancelDialog" />
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1400; width: 90%; max-width: 500px;">
        <MudPaper Elevation="8" Class="pa-6">
            <MudStack Spacing="3">
                <MudStack Row="true" JustifyContent="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Class="mr-2" />
                        Confirmar Cancelación
                    </MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                  Color="Color.Default" 
                                  OnClick="CloseCancelDialog" />
                </MudStack>

                <MudDivider />

                <MudAlert Severity="Severity.Warning" Dense="true">
                    <MudText Typo="Typo.body1">
                        ¿Está seguro que desea cancelar esta cita médica?
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                        Esta acción no se puede deshacer.
                    </MudText>
                </MudAlert>

                <MudDivider />

                <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd">
                    <MudButton Variant="Variant.Text" 
                              Color="Color.Default"
                              OnClick="CloseCancelDialog"
                              Disabled="_isCanceling">
                        Volver
                    </MudButton>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Error" 
                               OnClick="ConfirmCancelAppointment"
                               StartIcon="@Icons.Material.Filled.Cancel"
                               Disabled="_isCanceling">
                        @if (_isCanceling)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Cancelando...</MudText>
                        }
                        else
                        {
                            <MudText>Cancelar Cita</MudText>
                        }
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>
    </div>
}

@code {
    private List<VwPatientAppointment>? _myAppointments;
    private bool _isLoading = true;
    private bool _showCancelDialog = false;
    private bool _isCanceling = false;
    private int _appointmentToCancel = 0;

    protected override async Task OnInitializedAsync()
    {
        var usuarioActual = SessionService.CurrentUser;

        if (usuarioActual != null && usuarioActual.RoleName == "Paciente")
        {
            await LoadAppointments();
        }
    }

    private async Task LoadAppointments()
    {
        try
        {
            _isLoading = true;
            
            if (SessionService.CurrentUser == null)
            {
                Snackbar.Add("Error: Usuario no autenticado", Severity.Error);
                return;
            }
            
            int patientId = await PatientService.GetPatientIdByUserIdAsync(SessionService.CurrentUser.UserID);
            
            _myAppointments = await PatientService.GetMyAppointmentsAsync(patientId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar citas: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Programada" => Color.Primary,
        "Completada" => Color.Success,
        "Cancelada" => Color.Error,
        _ => Color.Default
    };

    private void OpenCancelDialog(int appointmentId)
    {
        _appointmentToCancel = appointmentId;
        _showCancelDialog = true;
    }

    private void CloseCancelDialog()
    {
        _showCancelDialog = false;
        _appointmentToCancel = 0;
        _isCanceling = false;
    }

    private async Task ConfirmCancelAppointment()
    {
        if (_isCanceling)
        {
            return;
        }

        _isCanceling = true;

        try
        {
            await PatientService.CancelAppointmentAsync(_appointmentToCancel);
            
            Snackbar.Add("Cita cancelada exitosamente", Severity.Success);
            
            CloseCancelDialog();
            
            await LoadAppointments();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cancelar: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isCanceling = false;
        }
    }
}