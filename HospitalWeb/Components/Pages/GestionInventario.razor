@page "/gestion-inventario"
@using HospitalData.Services
@using HospitalData.DTOs
@inject IStaffService StaffService
@inject ICatalogService CatalogService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Gestión de Inventario</PageTitle>

<Autorizacion RolRequerido="Administrativo">

    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
        
        <MudStack Spacing="3">
            
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Inventory" Color="Color.Success" Size="Size.Large" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h4">Gestión de Inventario</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Administración de medicamentos y stock
                    </MudText>
                </MudStack>
            </MudStack>

            <MudDivider />

            <MudGrid>
                
                <MudItem xs="12" md="4">
                    <MudStack Spacing="3">
                        
                        @if (_showingDeleted)
                        {
                            <MudAlert Severity="Severity.Warning" Icon="@Icons.Material.Filled.Block">
                                El formulario de creación y edición está deshabilitado mientras visualizas la papelera de reciclaje.
                            </MudAlert>
                        }
                        else
                        {
                            <MudCard Elevation="3" Class="@(_isEditing ? "border-solid border-2 border-primary" : "")">
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudIcon Icon="@(_isEditing ? Icons.Material.Filled.Edit : Icons.Material.Filled.AddCircle)" 
                                                     Color="@(_isEditing ? Color.Primary : Color.Success)" 
                                                     Size="Size.Medium" />
                                            <MudText Typo="Typo.h6">
                                                @(_isEditing ? "Editar Medicamento" : "Nuevo Medicamento")
                                            </MudText>
                                        </MudStack>
                                    </CardHeaderContent>
                                </MudCardHeader>
                                <MudCardContent>
                                    <EditForm Model="_formModel" OnValidSubmit="HandleSubmitForm">
                                        <DataAnnotationsValidator />
                                        
                                        <MudStack Spacing="3">
                                            <MudTextField @bind-Value="_formModel.Name"
                                                          Label="Nombre del Medicamento"
                                                          Variant="Variant.Outlined"
                                                          Required="true"
                                                          Adornment="Adornment.Start"
                                                          AdornmentIcon="@Icons.Material.Filled.Medication" />

                                            <MudTextField @bind-Value="_formModel.Description"
                                                          Label="Descripción"
                                                          Variant="Variant.Outlined"
                                                          Lines="3"
                                                          Adornment="Adornment.Start"
                                                          AdornmentIcon="@Icons.Material.Filled.Description" />

                                            @if (_isEditing)
                                            {
                                                <MudAlert Severity="Severity.Info" Dense="true" Class="my-2">
                                                    Stock Actual: <strong>@_currentStockEditing</strong><br/>
                                                    Ingresa un valor (+/-) para ajustar.
                                                </MudAlert>
                                                
                                                <MudNumericField @bind-Value="_formModel.Quantity"
                                                                 Label="Ajuste de Stock (+/-)"
                                                                 Variant="Variant.Outlined"
                                                                 HelperText="Ej: +50 (compra), -5 (corrección)"
                                                                 Adornment="Adornment.Start"
                                                                 AdornmentIcon="@Icons.Material.Filled.Exposure" />
                                            }
                                            else
                                            {
                                                <MudNumericField @bind-Value="_formModel.Quantity"
                                                                 Label="Cantidad Inicial"
                                                                 Variant="Variant.Outlined"
                                                                 Min="0"
                                                                 Adornment="Adornment.Start"
                                                                 AdornmentIcon="@Icons.Material.Filled.Numbers" />
                                            }

                                            <MudStack Row="true" Spacing="2">
                                                @if (_isEditing)
                                                {
                                                    <MudButton Variant="Variant.Outlined" 
                                                               Color="Color.Secondary" 
                                                               OnClick="CancelEdit"
                                                               FullWidth="true">
                                                        Cancelar
                                                    </MudButton>
                                                }
                                                
                                                <MudButton Variant="Variant.Filled"
                                                           Color="@(_isEditing ? Color.Primary : Color.Success)"
                                                           FullWidth="true"
                                                           StartIcon="@(_isEditing ? Icons.Material.Filled.Save : Icons.Material.Filled.Add)"
                                                           ButtonType="ButtonType.Submit">
                                                    @(_isEditing ? "Guardar Cambios" : "Crear")
                                                </MudButton>
                                            </MudStack>

                                        </MudStack>
                                    </EditForm>
                                </MudCardContent>
                            </MudCard>

                            @if (!_isEditing)
                            {
                                <MudCard Elevation="3">
                                    <MudCardHeader>
                                        <CardHeaderContent>
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@Icons.Material.Filled.FlashOn" Color="Color.Warning" Size="Size.Medium" />
                                                <MudText Typo="Typo.h6">Reposición Rápida</MudText>
                                            </MudStack>
                                        </CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        <EditForm Model="_stockUpdate" OnValidSubmit="HandleActualizarStockRapido">
                                            <DataAnnotationsValidator />
                                            <MudStack Spacing="3">
                                                <MudSelect T="int" @bind-Value="_stockUpdate.MedicationId" Label="Medicamento" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                                                    <MudSelectItem T="int" Value="0">-- Seleccione --</MudSelectItem>
                                                    @if (_inventario != null)
                                                    {
                                                        @foreach (var item in _inventario)
                                                        {
                                                            <MudSelectItem T="int" Value="@item.MedicationId">@item.Name</MudSelectItem>
                                                        }
                                                    }
                                                </MudSelect>
                                                <MudNumericField @bind-Value="_stockUpdate.QuantityToAdd" Label="Cantidad a Sumar" Variant="Variant.Outlined" Min="1" />
                                                <MudButton Variant="Variant.Filled" Color="Color.Warning" FullWidth="true" StartIcon="@Icons.Material.Filled.AddShoppingCart" ButtonType="ButtonType.Submit">Reponer Stock</MudButton>
                                            </MudStack>
                                        </EditForm>
                                    </MudCardContent>
                                </MudCard>
                            }
                        }

                    </MudStack>
                </MudItem>

                <MudItem xs="12" md="8">
                    <MudCard Elevation="3">
                        <MudCardContent>
                            
                            <MudStack Row="true" JustifyContent="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                                
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudSwitch T="bool" 
                                               ValueChanged="OnShowDeletedChanged"
                                               Color="Color.Error"
                                               Label="Papelera" />
                                    
                                    <MudDivider Vertical="true" FlexItem="true" Class="mx-2"/>

                                    <MudIcon Icon="@Icons.Material.Filled.Inventory" Color="Color.Success" />
                                    <MudText Typo="Typo.h6">Items</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success">
                                        @(_inventario?.Count ?? 0)
                                    </MudChip>
                                </MudStack>

                                <MudTextField @bind-Value="_searchInventory" 
                                              Placeholder="Buscar medicamento..." 
                                              Adornment="Adornment.Start" 
                                              AdornmentIcon="@Icons.Material.Filled.Search" 
                                              IconSize="Size.Medium"
                                              Variant="Variant.Outlined"
                                              Margin="Margin.Dense"
                                              Clearable="true"
                                              Style="max-width: 300px;" />
                            </MudStack>

                            @if (_isLoading)
                            {
                                <MudProgressCircular Color="Color.Success" Size="Size.Large" Indeterminate="true" Class="align-self-center my-4" />
                            }
                            else if (_inventario == null || !_inventario.Any())
                            {
                                <MudAlert Severity="Severity.Info" Class="my-4">
                                    @(_showingDeleted ? "La papelera de inventario está vacía." : "El inventario está vacío.")
                                </MudAlert>
                            }
                            else
                            {
                                <MudTable Items="@_inventario" Dense="true" Hover="true" Striped="true" Elevation="0" Filter="new Func<InventoryDto,bool>(FilterInventory)">
                                    <HeaderContent>
                                        <MudTh>Medicamento</MudTh>
                                        <MudTh>Stock</MudTh>
                                        <MudTh>Actualizado</MudTh>
                                        <MudTh Style="text-align:center">Acciones</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd DataLabel="Medicamento">
                                            <MudStack Spacing="0">
                                                <MudText Typo="Typo.body1">
                                                    <strong>@context.Name</strong>
                                                    @if (_editingId == context.MedicationId) 
                                                    { 
                                                        <MudChip T="string" Color="Color.Primary" Size="Size.Small" Class="ml-2">Editando</MudChip> 
                                                    }
                                                </MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Description</MudText>
                                            </MudStack>
                                        </MudTd>
                                        <MudTd DataLabel="Stock">
                                            @if (context.Quantity <= 10) { <MudChip T="string" Size="Size.Small" Color="Color.Error">@context.Quantity (Crítico)</MudChip> }
                                            else if (context.Quantity <= 50) { <MudChip T="string" Size="Size.Small" Color="Color.Warning">@context.Quantity (Bajo)</MudChip> }
                                            else { <MudChip T="string" Size="Size.Small" Color="Color.Success">@context.Quantity (OK)</MudChip> }
                                        </MudTd>
                                        <MudTd DataLabel="Actualizado">@context.LastUpdated.ToString("dd/MM HH:mm")</MudTd>
                                        
                                        <MudTd Style="text-align:center">
                                            @if (_showingDeleted)
                                            {
                                                <MudTooltip Text="Restaurar al Catálogo">
                                                    <MudIconButton Icon="@Icons.Material.Filled.RestoreFromTrash" 
                                                                   Color="Color.Success" 
                                                                   Size="Size.Small" 
                                                                   OnClick="@(() => HandleRestaurarMedicamento(context))" />
                                                </MudTooltip>
                                            }
                                            else
                                            {
                                                <MudTooltip Text="Editar">
                                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                                   Color="@(_editingId == context.MedicationId ? Color.Primary : Color.Default)" 
                                                                   Size="Size.Small" 
                                                                   OnClick="@(() => LoadMedicationForEdit(context))" />
                                                </MudTooltip>
                                                <MudTooltip Text="Eliminar">
                                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                                   Color="Color.Error" 
                                                                   Size="Size.Small" 
                                                                   OnClick="@(() => DeleteMedication(context))" />
                                                </MudTooltip>
                                            }
                                        </MudTd>

                                    </RowTemplate>
                                    <PagerContent><MudTablePager /></PagerContent>
                                </MudTable>
                            }
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        </MudStack>
    </MudContainer>

</Autorizacion>

@code {
    private List<InventoryDto>? _inventario;
    private UpdateStockDto _stockUpdate = new();
    
    private MedicationFormModel _formModel = new();
    private bool _isEditing = false;
    private int _editingId = 0;
    private int _currentStockEditing = 0;

    private string _searchInventory = "";
    private bool _isLoading = true;
    private bool _showingDeleted = false; 

    protected override async Task OnInitializedAsync()
    {
        await CargarInventario();
    }

    private async Task CargarInventario()
    {
        _isLoading = true;
        try
        {
            if (_showingDeleted)
            {
                _inventario = await CatalogService.GetDeletedMedicationsAsync();
            }
            else
            {
               _inventario = await StaffService.ObtenerInventarioAsync();
            }
        }
        catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
        finally { _isLoading = false; }
    }

    private async Task OnShowDeletedChanged(bool showDeleted)
    {
        _showingDeleted = showDeleted;
        if (_showingDeleted) CancelEdit(); 
        
        await CargarInventario();
        
        if(_showingDeleted) Snackbar.Add("Viendo medicamentos eliminados", Severity.Warning);
        else Snackbar.Add("Viendo inventario activo", Severity.Info);
    }

    private void LoadMedicationForEdit(InventoryDto item)
    {
        _isEditing = true;
        _editingId = item.MedicationId;
        _currentStockEditing = item.Quantity; 

        _formModel = new MedicationFormModel
        {
            Name = item.Name,
            Description = item.Description,
            Quantity = 0 
        };
        Snackbar.Add($"Editando: {item.Name}", Severity.Info);
    }

    private void CancelEdit()
    {
        _isEditing = false;
        _editingId = 0;
        _formModel = new(); 
    }

    private async Task HandleSubmitForm()
    {
        try
        {
            if (_isEditing)
            {
                var dto = new ModifyMedicationDto
                {
                    MedicationId = _editingId,
                    Name = _formModel.Name,
                    Description = _formModel.Description,
                    QuantityAdjustment = _formModel.Quantity == 0 ? null : _formModel.Quantity
                };

                await CatalogService.ModifyMedicationAsync(dto);
                Snackbar.Add("Medicamento actualizado", Severity.Success);
                CancelEdit(); 
            }
            else
            {
                var dto = new CreateMedicationDto
                {
                    Name = _formModel.Name,
                    Description = _formModel.Description,
                    InitialQuantity = _formModel.Quantity 
                };

                await StaffService.CrearMedicamentoAsync(dto);
                Snackbar.Add("Medicamento creado", Severity.Success);
                _formModel = new(); 
            }
            await CargarInventario();
        }
        catch (Exception ex) { Snackbar.Add(ex.Message, Severity.Error); }
    }

    private async Task HandleActualizarStockRapido()
    {
        try
        {
            await StaffService.ActualizarStockAsync(_stockUpdate);
            Snackbar.Add("Stock actualizado", Severity.Success);
            _stockUpdate = new();
            await CargarInventario();
        }
        catch (Exception ex) { Snackbar.Add(ex.Message, Severity.Error); }
    }

    private async Task DeleteMedication(InventoryDto item)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Eliminar Medicamento", 
            $"¿Seguro que deseas eliminar '{item.Name}'? Desaparecerá de futuras recetas.", 
            yesText: "Eliminar", cancelText: "Cancelar");

        if (result == true)
        {
            try
            {
                await CatalogService.DeactivateMedicationAsync(item.MedicationId);
                Snackbar.Add("Medicamento eliminado", Severity.Success);
                if (_editingId == item.MedicationId) CancelEdit();
                await CargarInventario();
            }
            catch (Exception ex) { Snackbar.Add(ex.Message, Severity.Error); }
        }
    }

    private async Task HandleRestaurarMedicamento(InventoryDto item)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Restaurar Medicamento", 
            $"¿Deseas volver a habilitar '{item.Name}' en el catálogo?", 
            yesText: "Restaurar", cancelText: "Cancelar");

        if (result == true)
        {
            try
            {
                await CatalogService.RestoreMedicationAsync(item.MedicationId);
                Snackbar.Add("Medicamento restaurado al catálogo", Severity.Success);
                await CargarInventario();
            }
            catch (Exception ex) { Snackbar.Add(ex.Message, Severity.Error); }
        }
    }

    private bool FilterInventory(InventoryDto item)
    {
        if (string.IsNullOrWhiteSpace(_searchInventory)) return true;
        if (item.Name.Contains(_searchInventory, StringComparison.OrdinalIgnoreCase)) return true;
        return false;
    }

    public class MedicationFormModel
    {
        public string Name { get; set; } = "";
        public string? Description { get; set; }
        public int Quantity { get; set; } 
    }
}