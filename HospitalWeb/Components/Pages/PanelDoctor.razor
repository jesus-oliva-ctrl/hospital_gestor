@page "/panel-doctor"
@using HospitalData.Models
@using HospitalData.Services
@inject IDoctorService DoctorService
@inject UserSessionService SessionService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Mi Panel</PageTitle>

<Autorizacion RolRequerido="Medico">
    
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
        
        <MudStack Spacing="3">
            
            <MudStack Row="true" JustifyContent="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.MedicalServices" Color="Color.Primary" Size="Size.Large" />
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.h4">Mi Agenda de Citas</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            @DateTime.Now.ToString("dddd, dd MMMM yyyy", new System.Globalization.CultureInfo("es-ES"))
                        </MudText>
                    </MudStack>
                </MudStack>
                
                @if (_agenda != null && _agenda.Any())
                {
                    <MudChip T="string" Icon="@Icons.Material.Filled.Event" Color="Color.Primary" Size="Size.Large">
                        @_agenda.Count cita@(_agenda.Count != 1 ? "s" : "") programada@(_agenda.Count != 1 ? "s" : "")
                    </MudChip>
                }
            </MudStack>

            <MudDivider />

            @if (_isLoading)
            {
                <MudPaper Elevation="0" Class="d-flex justify-center align-center pa-8">
                    <MudStack AlignItems="AlignItems.Center" Spacing="3">
                        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                        <MudText Typo="Typo.h6" Color="Color.Secondary">Cargando tu agenda...</MudText>
                    </MudStack>
                </MudPaper>
            }
            else if (_agenda == null || !_agenda.Any())
            {
                <MudPaper Elevation="2" Class="pa-8">
                    <MudStack AlignItems="AlignItems.Center" Spacing="3">
                        <MudIcon Icon="@Icons.Material.Filled.EventAvailable" 
                                Size="Size.Large" 
                                Color="Color.Success" 
                                Style="font-size: 80px;" />
                        <MudText Typo="Typo.h6" Align="Align.Center">
                            No tienes citas programadas
                        </MudText>
                        <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
                            Tu agenda está libre. Disfruta tu tiempo.
                        </MudText>
                    </MudStack>
                </MudPaper>
            }
            else
            {
                <MudGrid>
                    @foreach (var cita in _agenda.OrderBy(c => c.AppointmentDate))
                    {
                        var isToday = cita.AppointmentDate.Date == DateTime.Today;
                        var isPast = cita.AppointmentDate < DateTime.Now;
                        var isUpcoming = cita.AppointmentDate >= DateTime.Now && cita.AppointmentDate <= DateTime.Now.AddHours(2);

                        <MudItem xs="12" md="6" lg="4">
                            <MudCard Elevation="3" Class="@(isUpcoming ? "mud-elevation-8" : "")">
                                
                                @if (isUpcoming)
                                {
                                    <MudCardHeader Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <CardHeaderContent>
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Material.Filled.NotificationImportant" Color="Color.Surface" />
                                                <MudText Typo="Typo.h6" Color="Color.Surface">PRÓXIMA CITA</MudText>
                                            </MudStack>
                                        </CardHeaderContent>
                                    </MudCardHeader>
                                }
                                else if (isToday)
                                {
                                    <MudCardHeader Style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                        <CardHeaderContent>
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Material.Filled.Today" Color="Color.Surface" />
                                                <MudText Typo="Typo.h6" Color="Color.Surface">HOY</MudText>
                                            </MudStack>
                                        </CardHeaderContent>
                                    </MudCardHeader>
                                }

                                <MudCardContent>
                                    <MudStack Spacing="3">
                                        
                                        <MudStack Row="true" JustifyContent="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                            <MudStack Spacing="1">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">Fecha</MudText>
                                                <MudText Typo="Typo.body1">
                                                    <strong>@cita.AppointmentDate.ToString("dd/MM/yyyy")</strong>
                                                </MudText>
                                            </MudStack>
                                            <MudStack Spacing="1" AlignItems="AlignItems.End">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">Hora</MudText>
                                                <MudChip T="string" Size="Size.Small" Color="Color.Primary" Icon="@Icons.Material.Filled.Schedule">
                                                    @cita.AppointmentDate.ToString("HH:mm")
                                                </MudChip>
                                            </MudStack>
                                        </MudStack>

                                        <MudDivider />

                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudAvatar Color="Color.Secondary" Size="Size.Medium">
                                                <MudIcon Icon="@Icons.Material.Filled.Person" />
                                            </MudAvatar>
                                            <MudStack Spacing="0">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">Paciente</MudText>
                                                <MudText Typo="Typo.body1">
                                                    <strong>@cita.PatientFirstName @cita.PatientLastName</strong>
                                                </MudText>
                                            </MudStack>
                                        </MudStack>

                                        @if (!string.IsNullOrEmpty(cita.PatientPhone))
                                        {
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Color="Color.Info" />
                                                <MudText Typo="Typo.body2">@cita.PatientPhone</MudText>
                                            </MudStack>
                                        }

                                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(cita.Status)">
                                            @cita.Status
                                        </MudChip>

                                    </MudStack>
                                </MudCardContent>

                                <MudCardActions>
                                    <MudButton Variant="Variant.Filled" 
                                              Color="Color.Primary" 
                                              FullWidth="true"
                                              StartIcon="@Icons.Material.Filled.MedicalServices"
                                              Href="@($"/cita/{cita.AppointmentId}")">
                                        Atender Paciente
                                    </MudButton>
                                </MudCardActions>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>

                <MudPaper Elevation="0" Class="pa-4 mt-4">
                    <MudAlert Severity="Severity.Info" Dense="true" Icon="@Icons.Material.Filled.Info">
                        Haz clic en "Atender Paciente" para ver el historial, crear prescripciones y finalizar la consulta.
                    </MudAlert>
                </MudPaper>
            }

        </MudStack>

    </MudContainer>

</Autorizacion>

@code {
    private List<VwDoctorAgendaSummary>? _agenda;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        if (SessionService.CurrentUser?.RoleName == "Medico")
        {
            await LoadAgenda();
        }
    }

    private async Task LoadAgenda()
    {
        try
        {
            _isLoading = true;
            int doctorUserId = SessionService.CurrentUser.UserID;
            _agenda = await DoctorService.GetMyAgendaAsync(doctorUserId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar la agenda: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private Color GetStatusColor(string? status) => status switch
    {
        "Programada" => Color.Primary,
        "Completada" => Color.Success,
        "Cancelada" => Color.Error,
        _ => Color.Default
    };
}