@using HospitalData.DTOs
@using HospitalData.Services
@inject IPatientService PatientService
@inject ISnackbar Snackbar

<MudCard Elevation="3">
    <MudCardHeader>
        <CardHeaderContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Description" Color="Color.Primary" Size="Size.Medium" />
                <MudText Typo="Typo.h6">Historial Clínico del Paciente</MudText>
            </MudStack>
        </CardHeaderContent>
    </MudCardHeader>

    <MudCardContent>
        @if (_isLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="pa-4">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                <MudText Typo="Typo.body2" Color="Color.Secondary">Cargando historial...</MudText>
            </MudStack>
        }
        else if (_historial == null || !_historial.Any())
        {
            <MudAlert Severity="Severity.Info" Dense="true" Icon="@Icons.Material.Filled.Info">
                Este paciente no tiene registros médicos previos
            </MudAlert>
        }
        else
        {
            <MudTimeline TimelineOrientation="TimelineOrientation.Vertical" TimelinePosition="TimelinePosition.Start">
                @foreach (var registro in _historial)
                {
                    <MudTimelineItem Color="Color.Primary" Size="Size.Small">
                        <ItemOpposite>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @registro.VisitDate.ToString("dd MMM yyyy")
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @registro.VisitDate.ToString("HH:mm")
                            </MudText>
                        </ItemOpposite>
                        <ItemContent>
                            <MudPaper Elevation="2" Class="pa-3 mb-2">
                                <MudStack Spacing="2">
                                    <MudStack Row="true" JustifyContent="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                        <MudChip T="string" Size="Size.Small" 
                                                Color="Color.Info" 
                                                Icon="@Icons.Material.Filled.MedicalServices">
                                            Consulta Médica
                                        </MudChip>
                                    </MudStack>
                                    
                                    <MudText Typo="Typo.body1">
                                        @registro.Description
                                    </MudText>
                                    
                                    <MudDivider />
                                    
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Color="Color.Secondary" />
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            Atendido por médico tratante
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        </ItemContent>
                    </MudTimelineItem>
                }
            </MudTimeline>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public int PatientId { get; set; }

    private List<MedicalHistoryDto>? _historial;
    private bool _isLoading = false;

    protected override async Task OnParametersSetAsync()
    {
        if (PatientId > 0)
        {
            _isLoading = true;
            try
            {
                _historial = await PatientService.GetMyMedicalHistoryAsync(PatientId);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error al cargar historial: {ex.Message}", Severity.Error);
            }
            finally
            {
                _isLoading = false;
            }
        }
    }
}