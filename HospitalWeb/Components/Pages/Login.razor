@page "/login"
@using HospitalData.Services
@inject IAuthService AuthService
@inject UserSessionService SessionService 
@inject NavigationManager NavigationManager

<PageTitle>Login</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex justify-center align-center" Style="height: 100vh;">
    
    <MudCard Elevation="4" Class="pa-4" Style="width: 100%; max-width: 400px; border-radius: 8px;">
        
        <MudCardHeader Class="d-flex flex-column align-center">
            <CardHeaderContent>
                <div class="d-flex justify-center mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.LocalHospital" Color="Color.Primary" Size="Size.Large" Style="font-size: 3rem;" />
                </div>
                <MudText Typo="Typo.h5" Align="Align.Center" Class="mt-2"><b>Iniciar Sesión</b></MudText>
            </CardHeaderContent>
        </MudCardHeader>

        <MudCardContent>
            
            <MudTextField @bind-Value="_username" 
                          Label="Usuario" 
                          Variant="Variant.Outlined" 
                          Adornment="Adornment.Start" 
                          AdornmentIcon="@Icons.Material.Filled.Person"
                          Margin="Margin.Dense"
                          Class="mb-4" />

            <MudTextField @bind-Value="_password" 
                          Label="Contraseña" 
                          Variant="Variant.Outlined" 
                          InputType="@_passwordInput"
                          Adornment="Adornment.End"
                          AdornmentIcon="@_passwordIcon"
                          OnAdornmentClick="TogglePasswordVisibility"
                          Margin="Margin.Dense"
                          Class="mb-2" />

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Dense="true" Class="mt-2" ContentAlignment="HorizontalAlignment.Center">
                    @_errorMessage
                </MudAlert>
            }

        </MudCardContent>

        <MudCardActions Class="d-flex justify-center pb-4 px-4">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       FullWidth="true" 
                       Size="Size.Large"
                       OnClick="HandleLogin">
                Ingresar
            </MudButton>
        </MudCardActions>
    </MudCard>

</MudContainer>

@code {
    private string _username = string.Empty;
    private string _password = string.Empty;
    private string? _errorMessage;

    bool _isShow;
    InputType _passwordInput = InputType.Password;
    string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    void TogglePasswordVisibility()
    {
        if (_isShow)
        {
            _isShow = false;
            _passwordIcon = Icons.Material.Filled.VisibilityOff;
            _passwordInput = InputType.Password;
        }
        else
        {
            _isShow = true;
            _passwordIcon = Icons.Material.Filled.Visibility;
            _passwordInput = InputType.Text;
        }
    }

    private async Task HandleLogin()
    {
        _errorMessage = null; 
        try
        {
            var user = await AuthService.LoginAsync(_username, _password);

            if (user != null)
            {
                SessionService.Login(user);
                NavigationManager.NavigateTo("/");
            }
            else
            {
                _errorMessage = "Usuario o contraseña incorrectos.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "Ocurrió un error al intentar iniciar sesión.";
            Console.WriteLine(ex.Message); 
        }
    }
}