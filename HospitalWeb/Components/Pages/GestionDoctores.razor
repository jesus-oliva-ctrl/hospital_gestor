@page "/gestion-doctores"
@using HospitalData.Models
@using HospitalData.Services
@using HospitalData.DTOs
@using HospitalWeb.Components.Shared
@inject IAdminDoctorService DoctorService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Gestión de Doctores</PageTitle>

<Autorizacion RolRequerido="Administrativo">

    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
        
        <MudStack Spacing="3">
            
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.MedicalServices" Color="Color.Primary" Size="Size.Large" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h4">Directorio Médico</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Gestión de médicos y especialistas del hospital
                    </MudText>
                </MudStack>
            </MudStack>

            <MudDivider />

            <MudTabs Elevation="4" Rounded="true" ApplyEffectsToContainer="true" Color="Color.Primary">
                
                <MudTabPanel Text="Lista de Doctores" Icon="@Icons.Material.Filled.List">
                    <MudPaper Elevation="0" Class="pa-4">
                        
                        <MudStack Row="true" JustifyContent="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                            
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudSwitch T="bool" 
                                           ValueChanged="OnShowDeletedChanged"
                                           Color="Color.Error"
                                           Label="Papelera" />
                                
                                <MudDivider Vertical="true" FlexItem="true" Class="mx-2"/>

                                <MudIcon Icon="@Icons.Material.Filled.Badge" Color="Color.Primary" />
                                <MudText Typo="Typo.h6">Doctores</MudText>
                                
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary">
                                    @(_listaDoctores?.Count ?? 0)
                                </MudChip>
                            </MudStack>

                            <MudTextField @bind-Value="_searchString" 
                                          Placeholder="Buscar por nombre..." 
                                          Adornment="Adornment.Start" 
                                          AdornmentIcon="@Icons.Material.Filled.Search" 
                                          IconSize="Size.Medium"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          Clearable="true" 
                                          Class="mt-0"
                                          Style="min-width: 300px;"/>
                        </MudStack>
                        @if (_isLoading)
                        {
                            <MudStack AlignItems="AlignItems.Center" Spacing="3" Class="pa-8">
                                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                                <MudText Typo="Typo.h6" Color="Color.Secondary">Cargando directorio médico...</MudText>
                            </MudStack>
                        }
                        else if (_listaDoctores == null || !_listaDoctores.Any())
                        {
                            <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info" Class="my-4">
                                @(_showingDeleted ? "La papelera de reciclaje está vacía." : "No hay doctores registrados en el sistema.")
                            </MudAlert>
                        }
                        else
                        {
                            <MudTable Items="@_listaDoctores" 
                                      Dense="false" 
                                      Hover="true" 
                                      Bordered="false" 
                                      Striped="true" 
                                      Filter="new Func<DoctorProfileDto,bool>(FilterFunc1)"
                                      Elevation="0">
                                
                                <HeaderContent>
                                    <MudTh>ID</MudTh>
                                    <MudTh><MudTableSortLabel SortBy="new Func<DoctorProfileDto, object>(x=>x.FirstName)">Nombre</MudTableSortLabel></MudTh>
                                    <MudTh><MudTableSortLabel SortBy="new Func<DoctorProfileDto, object>(x=>x.LastName)">Apellido</MudTableSortLabel></MudTh>
                                    <MudTh>Teléfono</MudTh>
                                    <MudTh><MudTableSortLabel SortBy="new Func<DoctorProfileDto, object>(x=>x.SpecialtyName ?? string.Empty)">Especialidad</MudTableSortLabel></MudTh>
                                    <MudTh Style="text-align:center">Acciones</MudTh>
                                </HeaderContent>

                                <RowTemplate>
                                    <MudTd DataLabel="ID">
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@context.DoctorId</MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Nombre">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudAvatar Color="Color.Primary" Size="Size.Small">
                                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                                            </MudAvatar>
                                            <MudText Typo="Typo.body1">@context.FirstName</MudText>
                                        </MudStack>
                                    </MudTd>
                                    <MudTd DataLabel="Apellido">
                                        <MudText Typo="Typo.body1"><strong>@context.LastName</strong></MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Teléfono">
                                        <MudText Typo="Typo.body2">@(string.IsNullOrEmpty(context.Phone) ? "-" : context.Phone)</MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Especialidad">
                                        @if (!string.IsNullOrEmpty(context.SpecialtyName))
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.LocalHospital">
                                                @context.SpecialtyName
                                            </MudChip>
                                        }
                                        else
                                        {
                                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">Sin especialidad</MudChip>
                                        }
                                    </MudTd>
                                    
                                    <MudTd Style="text-align:center">
                                        @if (_showingDeleted)
                                        {
                                            <MudTooltip Text="Restaurar Doctor">
                                                <MudIconButton Icon="@Icons.Material.Filled.RestoreFromTrash" 
                                                               Color="Color.Success" 
                                                               Size="Size.Small"
                                                               OnClick="@(() => HandleRestaurarDoctor(context))" />
                                            </MudTooltip>
                                        }
                                        else
                                        {
                                            <MudTooltip Text="Dar de baja">
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                               Color="Color.Error" 
                                                               Size="Size.Small"
                                                               OnClick="@(() => HandleEliminarDoctor(context))" />
                                            </MudTooltip>
                                        }
                                    </MudTd>

                                </RowTemplate>
                                <PagerContent>
                                    <MudTablePager PageSizeOptions="new int[]{10, 25, 50, 100}" />
                                </PagerContent>
                            </MudTable>
                        }
                    </MudPaper>
                </MudTabPanel>

                <MudTabPanel Text="Registrar Nuevo" Icon="@Icons.Material.Filled.PersonAdd">
                    <MudPaper Elevation="0" Class="pa-4">
                        <MudCard Elevation="2">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.PersonAddAlt1" Color="Color.Primary" Size="Size.Medium" />
                                        <MudText Typo="Typo.h6">Nuevo Médico</MudText>
                                    </MudStack>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <EditForm Model="_nuevoDoctor" OnValidSubmit="HandleCrearDoctor">
                                    <DataAnnotationsValidator />
                                    
                                    <MudGrid>
                                        <MudItem xs="12" sm="6">
                                            <MudTextField @bind-Value="_nuevoDoctor.FirstName" Label="Nombres" Variant="Variant.Outlined" Required="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Person" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6">
                                            <MudTextField @bind-Value="_nuevoDoctor.LastName" Label="Apellidos" Variant="Variant.Outlined" Required="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Person" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6">
                                            <MudTextField @bind-Value="_nuevoDoctor.Email" Label="Email" Variant="Variant.Outlined" InputType="InputType.Email" Required="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Email" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6">
                                            <MudTextField @bind-Value="_nuevoDoctor.Phone" Label="Teléfono" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Phone" />
                                        </MudItem>
                                        <MudItem xs="12">
                                            <MudSelect T="int" Label="Especialidad Médica" @bind-Value="_nuevoDoctor.SpecialtyID" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.LocalHospital" Required="true">
                                                <MudSelectItem Value="0">-- Seleccione Especialidad --</MudSelectItem>
                                                @foreach (var especialidad in _listaEspecialidades)
                                                {
                                                    <MudSelectItem Value="@especialidad.SpecialtyId">@especialidad.SpecialtyName</MudSelectItem>
                                                }
                                            </MudSelect>
                                        </MudItem>
                                    </MudGrid>

                                    <MudDivider Class="my-4" />

                                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" FullWidth="true" StartIcon="@Icons.Material.Filled.Save" ButtonType="ButtonType.Submit">Registrar Doctor</MudButton>
                                </EditForm>
                            </MudCardContent>
                        </MudCard>
                    </MudPaper>
                </MudTabPanel>
            </MudTabs>

        </MudStack>

    </MudContainer>

</Autorizacion>

@code {
    private List<DoctorProfileDto>? _listaDoctores;
    private List<SpecialtyDto> _listaEspecialidades = new();
    
    private CreateDoctorDto _nuevoDoctor = new();
    private string _searchString = "";
    private bool _isLoading = true;
    private bool _showingDeleted = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatosIniciales();
    }

    private async Task CargarDatosIniciales()
    {
        try
        {
            _isLoading = true;
            _listaEspecialidades = await DoctorService.GetSpecialtiesAsync();

            if (_showingDeleted)
            {
                _listaDoctores = await DoctorService.GetDeletedDoctorsAsync();
            }
            else
            {
                _listaDoctores = await DoctorService.GetAllDoctorsAsync();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    // --- EVENTO DEL SWITCH ---
    private async Task OnShowDeletedChanged(bool showDeleted)
    {
        _showingDeleted = showDeleted;
        await CargarDatosIniciales();
        
        if(_showingDeleted) 
            Snackbar.Add("Viendo papelera de reciclaje", Severity.Warning);
        else 
            Snackbar.Add("Viendo lista activa", Severity.Info);
    }

    private async Task HandleCrearDoctor()
    {
        if (_nuevoDoctor.SpecialtyID == 0)
        {
            Snackbar.Add("Seleccione una especialidad", Severity.Warning);
            return;
        }

        try
        {
            await DoctorService.CreateDoctorAsync(_nuevoDoctor);
            Snackbar.Add("Doctor creado exitosamente", Severity.Success);
            _nuevoDoctor = new();
            
            if (_showingDeleted) _showingDeleted = false; 
            await CargarDatosIniciales();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleEliminarDoctor(DoctorProfileDto doctor)
    {
        bool? confirmed = await DialogService.ShowMessageBox(
            "Confirmar Baja", 
            $"¿Desactivar al Dr. {doctor.FirstName} {doctor.LastName}?", 
            yesText: "Desactivar", cancelText: "Cancelar");

        if (confirmed == true)
        {
            try
            {
                await DoctorService.SoftDeleteDoctorAsync(doctor.DoctorId);
                Snackbar.Add("Doctor desactivado.", Severity.Success);
                await CargarDatosIniciales();
            }
            catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
        }
    }

    private async Task HandleRestaurarDoctor(DoctorProfileDto doctor)
    {
        bool? confirmed = await DialogService.ShowMessageBox(
            "Confirmar Restauración", 
            $"¿Reactivar al Dr. {doctor.FirstName} {doctor.LastName}?", 
            yesText: "Restaurar", cancelText: "Cancelar");

        if (confirmed == true)
        {
            try
            {
                await DoctorService.RestoreDoctorAsync(doctor.DoctorId);
                Snackbar.Add("Doctor restaurado.", Severity.Success);
                await CargarDatosIniciales();
            }
            catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); }
        }
    }

    private bool FilterFunc1(DoctorProfileDto element) => FilterFunc(element, _searchString);

    private bool FilterFunc(DoctorProfileDto element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString)) return true;
        if (element.FirstName.Contains(searchString, StringComparison.OrdinalIgnoreCase)) return true;
        if (element.LastName.Contains(searchString, StringComparison.OrdinalIgnoreCase)) return true;
        if ($"{element.FirstName} {element.LastName}".Contains(searchString, StringComparison.OrdinalIgnoreCase)) return true;
        if (element.SpecialtyName?.Contains(searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
        return false;
    }
}