@page "/gestion-doctores"
@using HospitalData.Models
@using HospitalData.Services
@using HospitalData.DTOs
@using HospitalWeb.Components.Shared
@inject IStaffService StaffService
@inject ISnackbar Snackbar

<PageTitle>Gestión de Doctores</PageTitle>

<Autorizacion RolRequerido="Administrativo">

    <MudText Typo="Typo.h4" Class="mb-4">Directorio Médico</MudText>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        
        <MudTabPanel Text="Lista de Doctores" Icon="@Icons.Material.Filled.List">
            <MudTable Items="@_listaDoctores" 
                      Dense="true" 
                      Hover="true" 
                      Bordered="true" 
                      Striped="true" 
                      Filter="new Func<Doctor,bool>(FilterFunc1)"
                      Loading="@(_listaDoctores == null)">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Doctores Registrados</MudText>
                    <MudSpacer />
                    <MudTextField @bind-Value="_searchString" 
                                  Placeholder="Buscar por nombre..." 
                                  Adornment="Adornment.Start" 
                                  AdornmentIcon="@Icons.Material.Filled.Search" 
                                  IconSize="Size.Medium" 
                                  Class="mt-0" />
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>ID</MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<Doctor, object>(x=>x.FirstName)">Nombre</MudTableSortLabel></MudTh>
                    <MudTh><MudTableSortLabel SortBy="new Func<Doctor, object>(x=>x.LastName)">Apellido</MudTableSortLabel></MudTh>
                    <MudTh>Teléfono</MudTh>
                    <MudTh>Especialidad</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="ID">@context.DoctorId</MudTd>
                    <MudTd DataLabel="Nombre">@context.FirstName</MudTd>
                    <MudTd DataLabel="Apellido">@context.LastName</MudTd>
                    <MudTd DataLabel="Teléfono">@context.Phone</MudTd>
                    <MudTd DataLabel="Especialidad">@context.Specialty?.SpecialtyName</MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudTabPanel>

        <MudTabPanel Text="Registrar Nuevo" Icon="@Icons.Material.Filled.PersonAdd">
            <MudCard>
                <MudCardContent>
                    <MudForm @ref="_form" @bind-IsValid="@_success">
                        <MudGrid>
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="_nuevoDoctor.FirstName" 
                                              Label="Nombres" 
                                              Required="true"
                                              RequiredError="El nombre es obligatorio" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="_nuevoDoctor.LastName" 
                                              Label="Apellidos" 
                                              Required="true"
                                              RequiredError="El apellido es obligatorio" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="_nuevoDoctor.Email" 
                                              Label="Email" 
                                              InputType="InputType.Email" 
                                              Required="true"
                                              RequiredError="El email es obligatorio" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="_nuevoDoctor.Phone" 
                                              Label="Teléfono" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudNumericField @bind-Value="_nuevoDoctor.SpecialtyID" 
                                                 Label="ID Especialidad" 
                                                 Min="1" 
                                                 Required="true"
                                                 RequiredError="La especialidad es obligatoria" />
                            </MudItem>
                        </MudGrid>
                    </MudForm>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               OnClick="HandleCrearDoctor" 
                               Disabled="@(!_success)">
                        Registrar Doctor
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudTabPanel>
    </MudTabs>

</Autorizacion>

@code {
    private List<Doctor>? _listaDoctores;
    private CreateDoctorDto _nuevoDoctor = new();
    private string _searchString = "";
    private bool _success;
    private MudForm? _form;

    protected override async Task OnInitializedAsync()
    {
        await CargarDoctores();
    }

    private async Task HandleCrearDoctor()
    {
        try
        {
            await StaffService.CrearDoctorAsync(_nuevoDoctor);
            Snackbar.Add("Doctor creado exitosamente", Severity.Success);
            _nuevoDoctor = new();
            await CargarDoctores();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task CargarDoctores()
    {
        try
        {
            _listaDoctores = await StaffService.ObtenerDoctoresAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar doctores: {ex.Message}", Severity.Error);
        }
    }

    private bool FilterFunc1(Doctor element) => FilterFunc(element, _searchString);

    private bool FilterFunc(Doctor element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString)) 
            return true;
        if (element.FirstName.Contains(searchString, StringComparison.OrdinalIgnoreCase)) 
            return true;
        if (element.LastName.Contains(searchString, StringComparison.OrdinalIgnoreCase)) 
            return true;
        if ($"{element.FirstName} {element.LastName}".Contains(searchString, StringComparison.OrdinalIgnoreCase)) 
            return true;
        return false;
    }
}